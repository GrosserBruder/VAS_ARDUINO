<h1 align="center">ОТЧЁТ <br> о результатах работы за ноябрь 2020 года</h1>
 
#### За отчётный период было выполнено следующее:
#### 1. Расширение элементной базы для совершенствования аппаратного модуля в части оповещения несанкционированного доступа на объект.

Для расширения элементной базы в части оповещения несанкционированного доступа на объект для аппаратной части был выбран и закуплен 
модуль на базе геркона LM393 (Рис.1). Слово «геркон» происходит от словосочетания «герметичный контакт».
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/1_%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D0%B8%D0%B9_%D0%B2%D0%B8%D0%B4_Arduino_%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F_%D0%BC%D0%B0%D0%B3%D0%BD%D0%B8%D1%82%D0%BD%D0%BE%D0%B3%D0%BE_%D0%B4%D0%B0%D1%82%D1%87%D0%B8%D0%BA%D0%B0_LM393_%D1%81_%D0%B3%D0%B5%D1%80%D0%BA%D0%BE%D0%BD%D0%BE%D0%BC.jpg"/>
</p>
<p align="center">Рисунок 1 – Внешний вид Arduino модуля магнитного датчика LM393 с герконом</p>

Геркон – это электромеханическое коммутационное устройство, изменяющее состояние подключённой электрической цепи при воздействии 
магнитного поля от постоянного магнита или внешнего электромагнита, например, соленоида. 
Это два разомкнутых (или замкнутых) контакта, находящихся в вакуумной колбе, которые меняют своё состояние на противоположное 
при воздействии на них магнитного поля. Герконы – очень популярные датчики, которые используются во многих задачах. 
Область применения: система охраны открытия-закрытия дверей и окон, контроль уровня жидкости, 
а также в качестве счётчиков скорости и других разнообразных счётчиков срабатываний. 

Закупленный модуль для Arduino собран на небольшой плате, габариты которой всего 32 мм х 14 мм, 
основная микросхема – это компаратор LM393. 
Все характеристики данного модуля представлены в таблице 1.
<p align="right">Таблица 1.</p>
<p align="center">Характеристики модуля магнитного датчика LM393 с герконом</p>

| Наименование | Значение  |
| :----------------- | :-------------: |
| Рабочее напряжение  | 3.3 В – 5 В |
| Потребляемый ток  | 10 мА |
| Выходной ток  | 15 мА |
| Используемый датчик  | геркон |
| Выходные данные  | TTL, цифровой сигнал (1 или 0) |
| Компаратор  | LM393 |
| Размеры  | 32 мм x 14 мм |
| Диаметр монтажного отверстия  | 2.5 мм |
| ОЗУ  | 2 Кбайт  |
| EEPROM  | 1 Кбайт  |
| Тактовая частота  | 16 МГц  |

В качестве датчика используется так называемый геркон, который имеет два проводника, заключенных в стеклянную трубку 
заполненной инертным газом (таким как азот, гелий или просто вакуум). 
Внутри проводники расположены параллельно стеклянной трубке и немного перекрывают друг друга, оставляя небольшой зазор (Рис. 2).
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/2_%D0%B2%D0%BD%D1%83%D1%82%D1%80%D0%B5%D0%BD%D0%BD%D0%B5%D0%B5_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%BE_%D0%B3%D0%B5%D1%80%D0%BA%D0%BE%D0%BD%D0%B0.jpg"/>
</p>
<p align="center">Рисунок 2 – Внутреннее устройство геркона</p>

Прикладывая магнит к стеклянной трубке, под действием силовых линий магнитного поля два проводника в трубке намагничиваются и притягиваются друг к другу. 
Убирая магнит, магнитная сила исчезает, два проводника размыкаются из-за их собственной упругости и цепь разрывается.

Модуль содержит три контакта, один контакт цифровой и два контакта для подключения питания. 
Так как геркон работает совместно с магнитом и когда его нет на цифровом выводе DO устанавливается высокое состояние, 
когда магнит установлен – низкое состояние. Расстояние срабатывание геркона и магнита составляет менее 1,5 см. 
Назначение контактов:
1.	Do – Цифровой выход.
2.	VCC – Питание модуля. 
3.	GND – Минусовой вывод. 

Схема расположения отдельных элементов данного модуля изображена на рисунке 3.
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/3_%D0%BF%D1%80%D0%B8%D0%BD%D1%86%D0%B8%D0%BF%D0%B8%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%81%D1%85%D0%B5%D0%BC%D0%B0_Arduino_%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F_%D1%81_%D0%B3%D0%B5%D1%80%D0%BA%D0%BE%D0%BD%D0%BE%D0%BC_LM393.jpg"/>
</p>
<p align="center">Рисунок 3 – Принципиальная схема Arduino модуля с герконом LM393/p>

Подключение модуля с герконом к управляемому устройству Arduino Nano необходимо начать с подключения «VCC» к питанию 3.3 В 
(допускается подключать и к 5 В), «GND» к «GND» выходу на Arduino и контакт «Do» к свободному цифровому пину, например, под номером D2 (Рис. 4).
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/4_%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_Arduino_%D0%BC%D0%BE%D0%B4%D1%83%D0%BB%D1%8F_%D1%81_%D0%B3%D0%B5%D1%80%D0%BA%D0%BE%D0%BD%D0%BE%D0%BC_%D0%BA_Arduino_Nano.jpg"/>
</p>
<p align="center">Рисунок 4 – Подключение Arduino модуля с герконом к Arduino Nano</p>

Оповещение о несанкционированном доступе осуществляется на управляющем устройстве путём считывания данных с герконов, 
установленных на каждом управляемом устройстве. Для реализации этого функционала были закуплены LED-светодиоды (3мм), 
а также были подобраны с помощью мультиметра резисторы сопротивлением 200Ом. 
Определение полярности светодиода изображено на рисунке 5.    
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/5_%D0%BF%D0%BE%D0%BB%D1%8F%D1%80%D0%BD%D0%BE%D1%81%D1%82%D1%8C_%D1%81%D0%B2%D0%B5%D1%82%D0%BE%D0%B4%D0%B8%D0%BE%D0%B4%D0%B0.jpg"/>
</p>
<p align="center">Рисунок 5 – Полярность светодиода</p>

Эти составляющие необходимо корректно соединить между собой в рамках единой цепи и интегрировать на управляющее устройство. 
Соединение компонентов между собой и к самой плате было реализовано с помощью паяльной станции. 
На плате Arduino Nano пины A0-A5 являются цифровыми и аналоговыми одновременно, 
а A6 и A7 – именно аналоговыми, то есть могут только читать аналоговый сигнал. 
Схема подключения компонентов к Arduino Nano изображена на рисунке 6 («катод» к «GND», а «анод» к аналоговому пину 1, используя его как цифровой).
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/6_%D1%81%D1%85%D0%B5%D0%BC%D0%B0_%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D1%8F_LED-%D1%81%D0%B2%D0%B5%D1%82%D0%BE%D0%B4%D0%B8%D0%BE%D0%B4%D0%B0_%D0%BA_Arduino_Nano.jpg"/>
</p>
<p align="center">Рисунок 6 – Схема подключения LED-светодиода к Arduino Nano</p>

#### 2. Разработка, тестирование и отладка программного обеспечения для разрабатываемого модуля.

После подключения Arduino модуля с герконом остаётся реализовать программную часть для данного модуля и убедиться в её правильной работоспособности. 
Так как все управляемые устройства должны быть взаимозаменяемыми, необходимо разработать универсальную прошивку, работающую на всех устройствах одинаково. 
Первым делом подключаем вывод модуля «Do» к цифровому входу 4 (пин 4) на плате. 
В прошивке указываем препроцессору об объявлении переменной GERKON_PIN:
```C++
    #define GERKON_PIN 4
```
В функцию setup() добавляем, что цифровой пин 4 работает на вход, то есть будет считывать показания с датчика, и включаем на нём внутренний подтягивающий резистор:
```C++  
    void setup() {
    ------------------------------------------------------------
    pinMode(GERKON_PIN, INPUT);
    digitalWrite(GERKON_PIN, HIGH);
    ------------------------------------------------------------
    }
```
Следующим этапом следует добавить считывание показаний в функцию loop():
```C++  
    ------------------------------------------------------------
    int isOpen = digitalRead(GERKON_PIN);
    delay(500);
    ------------------------------------------------------------
```
Для проверки правильности преобразования показаний, необходимо добавить поле isOpen в отправляемую по RS485 объявленную структуру данных:
```C++
    struct SEND_DATA_STRUCTURE {
        int ID;
      	float temp;
      	float voltage;
        int isOpen;
    };
```
Завершающим этапом отправляем показания, считанные c геркона и записанные в переменную isOpen, предварительно записав значение и в саму структуру данных для отправки по интерфейсу RS485:
```C++
    if (ETrx.receiveData()) {    
            txdata.ID = RS485ID;
            txdata.temp = temperature;
            txdata.voltage = voltage;
            txdata.isOpen = isOpen;
        
            digitalWrite(DIR, HIGH); // включаем передачу
            delay(50);
            ETtx.sendData(); //отправляем на управляющее устройство
            delay(50);
            digitalWrite(DIR, LOW);
    }
```
ДДля тестирования работоспособности модуля, нужно поднести магнит к одному из модулей с герконом на расстояние от 1см до 2см, 
и добавить следующие строчки кода в функции loop() сразу после считывания показаний, для их вывода в последовательный монитор порта:
```C++
    Serial.println("----------------");
    Serial.print("isOpen int value = ");
    Serial.println(isOpen);
    Serial.print("After read value");
    String convertIsOpenDoorValue = isOpen ? "Yes" : "No";
    Serial.print("Door is open = ");
    Serial.println(convertIsOpenDoorValue);
    Serial.println("----------------");
```
Разработанной модуль успешно прошёл как аппаратное, так и программное тестирование, 
а также была доказана работоспособность и корректность показаний на управляемых устройствах (Рис. 7) (Рис. 8).
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/7_%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80_Serial_(%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D0%B3%D0%BE)_%D0%BF%D0%BE%D1%80%D1%82%D0%B0_COM8.jpg"/>
</p>
<p align="center">Рисунок 7 – Монитор Serial (последовательного) порта COM8</p>

<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/8_%D0%B0%D0%BF%D0%BF%D0%B0%D1%80%D0%B0%D1%82%D0%BD%D0%BE%D0%B5_%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B8_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BE%D1%81%D0%BF%D0%BE%D1%81%D0%BE%D0%B1%D0%BD%D0%BE%D1%81%D1%82%D0%B8.jpg"/>
</p>
<p align="center">Рисунок 8 – Аппаратное подключение и тестирование работоспособности модуля с герконом</p>

По завершению тестирования управляемых устройств, остаётся добавить глобальную функцию оповещения о несанкционированном доступе в систему. 
После аппаратного подключения светодиодов с резисторами на управляющее устройство, необходимо реализовать программную 
часть для данного модуля и убедиться в её правильной работоспособности. 

Первым делом указываем препроцессору об объявлении переменной GERKON_LED_PIN_DEVICE_2 (пин А4 на плате), к которому подключаем «анод» от светодиода:
```C++
    #define GERKON_LED_PIN_DEVICE_2 A4
```
В функцию setup() добавляем, что этот пин работает на выход:
```C++
    void setup() {
        ---------------------------------------------------------------
        pinMode(GERKON_LED_PIN_DEVICE_2, OUTPUT);
        ---------------------------------------------------------------
    }	
```
Далее добавляем поле isOpen в структуру данных для обмена между всеми устройствами системы:
```C++
    struct RECEIVE_DATA_RS485{
        int ID;
        float temp;
        int isOpen;
        float voltage;
    };
```
Следующим этапом следует добавить считывание показаний в функцию 
loop() и включить мониторинг порта на управляющем устройстве для тестирования разработанного модуля периодически поднося магнит к датчику (Рис. 9).
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/9_%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0_%D0%BF%D0%BE%D0%BA%D0%B0%D0%B7%D0%B0%D0%BD%D0%B8%D0%B9_%D0%B4%D0%BB%D1%8F_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0_%D1%81_ID_%3D_2_%D0%B2_%D1%84%D1%83%D0%BD%D0%BA%D1%86%D0%B8%D0%B8_loop()_%D0%BD%D0%B0_master.jpg"/>
</p>
<p align="center">Рисунок 9 – Обработка показаний для устройства с ID=2 в функции loop() на master</p>

Оповещение о несанкционированном доступе в случае открытия двери изображено на рисунке 10.
<p align="center">
  <img src="https://github.com/NekitJavaDev/VAS_ARDUINO/blob/master/src/img/november/10_%D0%B2%D0%BD%D0%B5%D1%88%D0%BD%D0%B8%D0%B9_%D0%B2%D0%B8%D0%B4_%D1%83%D0%BF%D1%80%D0%B0%D0%B2%D0%BB%D1%8F%D1%8E%D1%89%D0%B5%D0%B3%D0%BE_%D1%83%D1%81%D1%82%D1%80%D0%BE%D0%B9%D1%81%D1%82%D0%B2%D0%B0_%D0%BF%D1%80%D0%B8_%D0%BE%D1%82%D0%BA%D1%80%D1%8B%D1%82%D0%B8%D0%B8_%D0%B4%D0%B2%D0%B5%D1%80%D0%B8.jpg"/>
</p>
<p align="center">Рисунок 10 – Внешний вид управляющего устройства при открытии двери</p>